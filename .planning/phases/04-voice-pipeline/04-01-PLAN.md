---
phase: 04-voice-pipeline
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/caal/utils/formatting.py
  - src/caal/settings.py
  - prompt/en/default.md
  - prompt/fr/default.md
autonomous: true

must_haves:
  truths:
    - "Date/time context in system prompt is formatted in the configured language"
    - "French prompt instructs the agent to respond in French, ensuring tool responses are reformulated in the configured language"
    - "English prompt is identical to current prompt (no regression)"
    - "Custom prompts still take priority over per-language defaults"
    - "Existing installations without per-language prompt directories continue working without errors"
  artifacts:
    - path: "src/caal/utils/formatting.py"
      provides: "French date/time formatting"
      contains: "language"
    - path: "src/caal/settings.py"
      provides: "Language-aware prompt loading"
      contains: "language"
    - path: "prompt/en/default.md"
      provides: "English system prompt"
      min_lines: 50
    - path: "prompt/fr/default.md"
      provides: "French system prompt"
      min_lines: 50
  key_links:
    - from: "src/caal/settings.py"
      to: "src/caal/utils/formatting.py"
      via: "format_date_speech_friendly(now, language=language)"
      pattern: "format_date_speech_friendly.*language"
    - from: "src/caal/settings.py"
      to: "prompt/en/default.md"
      via: "load_prompt_content resolves prompt/{lang}/default.md"
      pattern: "PROMPT_DIR.*language"
---

<objective>
Create per-language system prompts (EN/FR) and add French date/time formatting support.

Purpose: The agent needs localized system prompts so it responds in the user's configured language, and date/time context in the prompt must also be formatted in that language. The French prompt explicitly instructs the agent to respond in French, which also ensures tool responses are naturally reformulated in French.
Output: prompt/en/default.md, prompt/fr/default.md, updated formatting.py and settings.py
</objective>

<execution_context>
@/Users/mmaudet/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mmaudet/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-voice-pipeline/04-RESEARCH.md
@src/caal/utils/formatting.py
@src/caal/settings.py
@prompt/default.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add French date/time formatting</name>
  <files>src/caal/utils/formatting.py</files>
  <action>
Add a `language` parameter (default "en") to `format_date_speech_friendly()` and `format_time_speech_friendly()`.

For `format_date_speech_friendly(dt, language="en")`:
- When language == "fr":
  - French day names: lundi, mardi, mercredi, jeudi, vendredi, samedi, dimanche
  - French month names: janvier, fevrier, mars, avril, mai, juin, juillet, aout, septembre, octobre, novembre, decembre (use accented characters: fevrier->fevrier, aout->aout -- actually use proper French: janvier, fevrier, mars, avril, mai, juin, juillet, aout, septembre, octobre, novembre, decembre. Accents: fevrier = fevrier, aout = aout. Wait -- use the correct French: janvier, fevrier, mars, avril, mai, juin, juillet, aout, septembre, octobre, novembre, decembre. Actually the proper French with accents: fevrier -> "f\u00e9vrier", aout -> "ao\u00fbt")
  - French ordinals: only "premier" for day 1, all other days use cardinal numbers (2, 3, 4...)
  - French format: "lundi premier janvier 2026" or "lundi 21 janvier 2026" (no comma)
- When language == "en": keep existing English logic unchanged

For `format_time_speech_friendly(dt, language="en")`:
- When language == "fr":
  - 24-hour clock: "15 heures 30" or "15h30" -- use the spoken form "15 heures 30"
  - On the hour: "15 heures"
  - Special cases: "midi" (hour==12, minute==0), "minuit" (hour==0, minute==0)
- When language == "en": keep existing English logic unchanged

Also update `strip_markdown_for_tts` to handle French score patterns: the existing regex `(\d+)-(\d+)` -> "to" should remain for English. For French, this function doesn't need language awareness since it's called on LLM output which is already in the configured language.

Do NOT create a `number_to_ordinal_word` equivalent for French -- French dates use cardinal numbers except for "premier" on the 1st. Just handle it inline in the French date formatter.
  </action>
  <verify>
Run `uv run python -c "from caal.utils.formatting import format_date_speech_friendly, format_time_speech_friendly; from datetime import datetime; dt = datetime(2026, 1, 21, 15, 30); print(format_date_speech_friendly(dt, 'fr')); print(format_time_speech_friendly(dt, 'fr')); print(format_date_speech_friendly(dt, 'en')); print(format_time_speech_friendly(dt, 'en'))"` and verify:
- French date: "mercredi 21 janvier 2026"
- French time: "15 heures 30"
- English date: "Wednesday, January twenty-first, 2026"
- English time: "3:30 PM"

Also test edge cases:
- `format_date_speech_friendly(datetime(2026, 3, 1, 12, 0), 'fr')` should contain "premier mars"
- `format_time_speech_friendly(datetime(2026, 1, 1, 0, 0), 'fr')` should return "minuit"
- `format_time_speech_friendly(datetime(2026, 1, 1, 12, 0), 'fr')` should return "midi"
  </verify>
  <done>format_date_speech_friendly and format_time_speech_friendly accept a language parameter and produce correct French and English output</done>
</task>

<task type="auto">
  <name>Task 2: Create per-language prompt structure and update prompt loading</name>
  <files>prompt/en/default.md, prompt/fr/default.md, src/caal/settings.py</files>
  <action>
**Step 1: Create prompt directory structure**

1. Create `prompt/en/` directory
2. Copy `prompt/default.md` to `prompt/en/default.md` (exact copy, no changes)
3. Create `prompt/fr/default.md` -- a full French translation of the English prompt. Key translation notes:
   - Title: "# Assistant vocal"
   - Core instruction: "Tu es un assistant vocal ORIENTE ACTION." (use tu/toi, not vous)
   - "Quand on te demande de faire quelque chose:" then numbered list
   - Tool Priority -> "# Priorite des outils" (use accent: Priorit\u00e9)
   - Home Control section: keep `hass_control` as-is (it's a function name), translate the descriptions
   - Tool Response Handling: "Quand un outil renvoie du JSON avec un champ `message`, dis UNIQUEMENT ce message tel quel."
   - Voice Output: "Les reponses sont prononcees par TTS. Ecris en texte brut uniquement."
     - Numbers: "soixante-douze degres" pas "72 deg"
     - Dates: "mardi vingt-trois janvier" pas "23/01"
     - Times: "seize heures trente" pas "16h30"
   - Keep responses to 1-2 sentences -> "Limite tes reponses a une ou deux phrases"
   - "Sois chaleureux et utilise un ton naturel"
   - Add explicit instruction: "Reponds toujours en francais." (use accent: fran\u00e7ais) -- this MUST be present, as it ensures the agent responds in French including when reformulating tool responses
   - Rules section: translate all rules to French
   - Keep `{{CURRENT_DATE_CONTEXT}}` and `{{TIMEZONE}}` template variables as-is (they are replaced at runtime)
4. Keep `prompt/default.md` as-is for backward compatibility (existing installations without per-language dirs)
5. Keep `prompt/custom.md` path unchanged (language-neutral by design)

**Step 2: Update settings.py prompt loading**

1. Update `load_prompt_content(prompt_name=None)` to accept a `language` parameter:
   ```python
   def load_prompt_content(prompt_name: str | None = None, language: str = "en") -> str:
   ```
   - If prompt_name is "custom" and custom.md exists, return it (custom always wins, regardless of language)
   - Otherwise, try `PROMPT_DIR / language / f"{prompt_name}.md"` first
   - Fall back to `PROMPT_DIR / f"{prompt_name}.md"` for backward compatibility
   - This ensures existing installations without prompt/en/ still work

2. Update `load_prompt_with_context()` to accept a `language` parameter:
   ```python
   def load_prompt_with_context(
       timezone_id: str = "America/Los_Angeles",
       timezone_display: str = "Pacific Time",
       language: str = "en",
   ) -> str:
   ```
   - Pass `language` to `load_prompt_content(language=language)`
   - Pass `language` to `format_date_speech_friendly(now, language=language)`
   - Pass `language` to `format_time_speech_friendly(now, language=language)`
   - For French, the date context string should be: `f"Nous sommes le {format_date_speech_friendly(now, language=language)}. Il est {format_time_speech_friendly(now, language=language)}, {timezone_display}."`
   - For English, keep current format: `f"Today is {format_date_speech_friendly(now, language=language)}. The current time is {format_time_speech_friendly(now, language=language)} {timezone_display}."`

3. Update `get_prompt_path()` -- this function is also used by `save_custom_prompt()` and `custom_prompt_exists()`. Keep it returning the flat path for custom prompts. The per-language resolution happens in `load_prompt_content()`.
  </action>
  <verify>
1. Verify prompt files exist:
   - `ls prompt/en/default.md prompt/fr/default.md prompt/default.md`
   - All three should exist

2. Verify French prompt content contains key French phrases:
   ```
   uv run python -c "
   from caal.settings import load_prompt_with_context
   en = load_prompt_with_context(language='en')
   fr = load_prompt_with_context(language='fr')
   print('EN prompt starts with:', en[:80])
   print('FR prompt starts with:', fr[:80])
   # English prompt check
   assert 'ACTION-ORIENTED' in en, 'English prompt missing ACTION-ORIENTED'
   # French prompt checks
   assert 'Assistant vocal' in fr, 'French prompt missing Assistant vocal'
   assert 'fran' in fr.lower(), 'French prompt missing instruction to respond in French'
   # Verify prompts are actually different (not just a copy)
   assert 'Nous sommes' not in en, 'English prompt should not contain French date context'
   # Verify French prompt explicitly instructs responding in French
   assert 'fran\u00e7ais' in fr.lower() or 'francais' in fr.lower(), 'French prompt must explicitly instruct responding in French'
   print('All content checks passed')
   "
   ```

3. Verify backward compatibility:
   ```
   uv run python -c "
   from caal.settings import load_prompt_content
   # Should load prompt/en/default.md (or fall back to prompt/default.md)
   content = load_prompt_content('default', language='en')
   assert len(content) > 100
   print('Backward compat OK, length:', len(content))
   "
   ```

4. Run linter: `uv run ruff check src/caal/settings.py src/caal/utils/formatting.py`
  </verify>
  <done>
- prompt/en/default.md exists with English prompt (identical to original)
- prompt/fr/default.md exists with French prompt containing "Assistant vocal" and an explicit "Reponds toujours en francais" instruction
- prompt/default.md still exists for backward compatibility
- load_prompt_content() accepts language parameter and resolves per-language prompt files
- load_prompt_with_context() accepts language parameter, passes it to formatting functions and prompt loading
- French date context string uses French phrasing ("Nous sommes le...")
- Custom prompt still takes priority regardless of language
- French prompt ensures tool responses are reformulated in French via the system-level language instruction
  </done>
</task>

</tasks>

<verification>
1. `uv run ruff check src/caal/settings.py src/caal/utils/formatting.py` passes
2. French formatting produces correct output for dates and times
3. Both EN and FR prompts load correctly via `load_prompt_with_context(language=...)`
4. French prompt contains "Assistant vocal" and explicit instruction to respond in French
5. English and French prompts are distinct (different content, different date context format)
6. Backward compatibility: `load_prompt_content("default")` still works (falls back correctly)
7. `prompt/default.md` still exists (not deleted)
</verification>

<success_criteria>
- format_date_speech_friendly(dt, "fr") produces "mercredi 21 janvier 2026" format
- format_time_speech_friendly(dt, "fr") produces "15 heures 30" format
- load_prompt_with_context(language="fr") returns French prompt with French date context
- load_prompt_with_context(language="en") returns English prompt with English date context (no regression)
- French prompt contains explicit instruction to respond in French (ensures tool response reformulation)
- Custom prompt loading is unaffected by language parameter
</success_criteria>

<output>
After completion, create `.planning/phases/04-voice-pipeline/04-01-SUMMARY.md`
</output>
