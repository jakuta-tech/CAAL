---
phase: 03-mobile-i18n
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - mobile/pubspec.yaml
  - mobile/l10n.yaml
  - mobile/lib/l10n/app_en.arb
  - mobile/lib/l10n/app_fr.arb
  - mobile/lib/providers/locale_provider.dart
  - mobile/lib/app.dart
  - mobile/lib/main.dart
autonomous: true

must_haves:
  truths:
    - "Flutter code generation produces AppLocalizations class"
    - "App loads with English locale by default"
    - "Locale can be changed via LocaleProvider and UI updates"
    - "Language setting syncs with backend on change"
  artifacts:
    - path: "mobile/l10n.yaml"
      provides: "Code generation configuration"
      contains: "arb-dir: lib/l10n"
    - path: "mobile/lib/l10n/app_en.arb"
      provides: "English translations template"
      contains: "@@locale"
    - path: "mobile/lib/l10n/app_fr.arb"
      provides: "French translations"
      contains: "@@locale"
    - path: "mobile/lib/providers/locale_provider.dart"
      provides: "Locale state management with backend sync"
      exports: ["LocaleProvider"]
  key_links:
    - from: "mobile/lib/app.dart"
      to: "AppLocalizations.delegate"
      via: "localizationsDelegates"
      pattern: "localizationsDelegates"
    - from: "mobile/lib/app.dart"
      to: "LocaleProvider"
      via: "Consumer widget"
      pattern: "Consumer.*LocaleProvider"
---

<objective>
Set up Flutter internationalization infrastructure with flutter_localizations SDK, ARB files, and LocaleProvider for runtime locale management.

Purpose: Enable the mobile app to support multiple languages with proper code generation and state management that syncs with the CAAL backend.

Output: Working i18n infrastructure with EN/FR ARB files, LocaleProvider for runtime locale changes, and MaterialApp wired with localization delegates.
</objective>

<execution_context>
@/Users/mmaudet/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mmaudet/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-mobile-i18n/03-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Configure Flutter l10n and add dependencies</name>
  <files>
    mobile/pubspec.yaml
    mobile/l10n.yaml
  </files>
  <action>
1. Update `mobile/pubspec.yaml`:
   - Add `flutter_localizations` SDK dependency under dependencies:
     ```yaml
     flutter_localizations:
       sdk: flutter
     ```
   - Add `generate: true` under the `flutter:` section (after uses-material-design)
   - Note: `intl: ^0.20.0` is already present

2. Create `mobile/l10n.yaml` at project root with:
   ```yaml
   arb-dir: lib/l10n
   template-arb-file: app_en.arb
   output-localization-file: app_localizations.dart
   output-class: AppLocalizations
   nullable-getter: false
   ```

3. Run `flutter pub get` in mobile directory to install dependencies.
  </action>
  <verify>
    - `flutter pub get` completes without errors
    - pubspec.yaml includes flutter_localizations and generate: true
    - l10n.yaml exists with correct configuration
  </verify>
  <done>Flutter l10n configured with dependencies installed</done>
</task>

<task type="auto">
  <name>Task 2: Create ARB translation files for EN/FR</name>
  <files>
    mobile/lib/l10n/app_en.arb
    mobile/lib/l10n/app_fr.arb
  </files>
  <action>
Create `mobile/lib/l10n/` directory and ARB files matching frontend translations for consistency.

**app_en.arb** (English template - source of truth):
```json
{
  "@@locale": "en",

  "welcomeSubtitle": "Chat live with your voice AI agent",
  "@welcomeSubtitle": { "description": "Subtitle on welcome screen" },

  "talkToAgent": "Talk to CAAL",
  "@talkToAgent": { "description": "Button to start conversation" },

  "connecting": "Connecting",
  "@connecting": { "description": "Button text while connecting" },

  "agentListening": "CAAL is listening",
  "@agentListening": { "description": "Status when agent is listening" },

  "agentIsListening": "Agent is listening",
  "@agentIsListening": { "description": "Placeholder when no messages" },

  "startConversation": "Start a conversation to see messages here.",
  "@startConversation": { "description": "Empty state subtitle" },

  "sayWakeWord": "Say \"Hey Jarvis\"",
  "@sayWakeWord": { "description": "Wake word prompt" },

  "waitingForWakeWord": "Waiting for wake word...",
  "@waitingForWakeWord": { "description": "Wake word waiting subtitle" },

  "screenshareView": "Screenshare View",
  "@screenshareView": { "description": "Screenshare placeholder" },

  "settings": "Settings",
  "@settings": { "description": "Settings button tooltip" },

  "settingsTitle": "Settings",
  "@settingsTitle": { "description": "Settings screen title" },

  "caalSetup": "CAAL Setup",
  "@caalSetup": { "description": "Setup screen title" },

  "save": "Save",
  "@save": { "description": "Save button" },

  "saving": "Saving...",
  "@saving": { "description": "Save in progress" },

  "test": "Test",
  "@test": { "description": "Test button" },

  "connect": "CONNECT",
  "@connect": { "description": "Connect button on setup" },

  "connection": "Connection",
  "@connection": { "description": "Connection section header" },

  "serverUrl": "Server URL",
  "@serverUrl": { "description": "Server URL field label" },

  "serverUrlHint": "http://192.168.1.100:3000",
  "@serverUrlHint": { "description": "Server URL placeholder" },

  "serverUrlRequired": "Server URL is required",
  "@serverUrlRequired": { "description": "Validation error" },

  "serverUrlInvalid": "Enter a valid URL",
  "@serverUrlInvalid": { "description": "Validation error" },

  "yourServerAddress": "Your CAAL server address",
  "@yourServerAddress": { "description": "Server URL helper text" },

  "connectedToServer": "Connected to CAAL server",
  "@connectedToServer": { "description": "Connection success" },

  "enterServerFirst": "Enter a valid server URL first",
  "@enterServerFirst": { "description": "Validation error" },

  "serverReturned": "Server returned {code}",
  "@serverReturned": { "description": "Server error with code", "placeholders": { "code": { "type": "int" } } },

  "couldNotConnect": "Could not connect to server",
  "@couldNotConnect": { "description": "Connection error" },

  "couldNotReach": "Could not reach server",
  "@couldNotReach": { "description": "Connection error" },

  "completeWizardFirst": "Complete the first-start wizard in your browser first",
  "@completeWizardFirst": { "description": "Setup not complete message" },

  "enterServerToStart": "Enter your server address to get started",
  "@enterServerToStart": { "description": "Setup instruction" },

  "completeWizardHint": "Complete the first-start wizard in your browser, then connect here.",
  "@completeWizardHint": { "description": "Setup hint" },

  "connectToServerFirst": "Connect to server to configure agent settings",
  "@connectToServerFirst": { "description": "Settings unavailable message" },

  "agent": "Agent",
  "@agent": { "description": "Agent section header" },

  "agentName": "Agent Name",
  "@agentName": { "description": "Agent name field" },

  "wakeGreetings": "Wake Greetings",
  "@wakeGreetings": { "description": "Wake greetings field" },

  "onePerLine": "One greeting per line",
  "@onePerLine": { "description": "Wake greetings hint" },

  "providers": "Providers",
  "@providers": { "description": "Providers section header" },

  "llmProvider": "LLM Provider",
  "@llmProvider": { "description": "LLM provider label" },

  "ollamaLocalPrivate": "Local, private",
  "@ollamaLocalPrivate": { "description": "Ollama subtitle" },

  "groqFastCloud": "Fast cloud",
  "@groqFastCloud": { "description": "Groq subtitle" },

  "ollamaHost": "Ollama Host",
  "@ollamaHost": { "description": "Ollama host field" },

  "apiKey": "API Key",
  "@apiKey": { "description": "API key field" },

  "model": "Model",
  "@model": { "description": "Model dropdown label" },

  "modelsAvailable": "{count} models available",
  "@modelsAvailable": { "description": "Model count", "placeholders": { "count": { "type": "int" } } },

  "apiKeyConfigured": "API key configured (enter new key to change)",
  "@apiKeyConfigured": { "description": "Groq key configured hint" },

  "connectionFailed": "Connection failed",
  "@connectionFailed": { "description": "Connection error" },

  "failedToConnect": "Failed to connect",
  "@failedToConnect": { "description": "Connection error" },

  "failedToValidate": "Failed to validate",
  "@failedToValidate": { "description": "Validation error" },

  "invalidApiKey": "Invalid API key",
  "@invalidApiKey": { "description": "API key error" },

  "ttsProvider": "TTS Provider",
  "@ttsProvider": { "description": "TTS provider label" },

  "kokoroGpuNeural": "GPU neural TTS",
  "@kokoroGpuNeural": { "description": "Kokoro subtitle" },

  "piperCpuLightweight": "CPU lightweight",
  "@piperCpuLightweight": { "description": "Piper subtitle" },

  "voice": "Voice",
  "@voice": { "description": "Voice dropdown label" },

  "integrations": "Integrations",
  "@integrations": { "description": "Integrations section header" },

  "homeAssistant": "Home Assistant",
  "@homeAssistant": { "description": "Home Assistant toggle" },

  "hostUrl": "Host URL",
  "@hostUrl": { "description": "Host URL field" },

  "accessToken": "Access Token",
  "@accessToken": { "description": "Access token field" },

  "connectedEntities": "Connected - {count} entities",
  "@connectedEntities": { "description": "HASS connected status", "placeholders": { "count": { "type": "int" } } },

  "connected": "Connected",
  "@connected": { "description": "Connected status" },

  "n8nMcpNote": "/mcp-server/http will be appended automatically",
  "@n8nMcpNote": { "description": "n8n URL note" },

  "llmSettings": "LLM Settings",
  "@llmSettings": { "description": "LLM settings section" },

  "temperature": "Temperature",
  "@temperature": { "description": "Temperature field" },

  "contextSize": "Context Size",
  "@contextSize": { "description": "Context size field" },

  "maxTurns": "Max Turns",
  "@maxTurns": { "description": "Max turns field" },

  "toolCache": "Tool Cache",
  "@toolCache": { "description": "Tool cache field" },

  "allowInterruptions": "Allow Interruptions",
  "@allowInterruptions": { "description": "Interruptions toggle" },

  "interruptAgent": "Interrupt the agent while speaking",
  "@interruptAgent": { "description": "Interruptions description" },

  "endpointingDelay": "Endpointing Delay (s)",
  "@endpointingDelay": { "description": "Endpointing delay field" },

  "endpointingDelayDesc": "How long to wait after you stop speaking",
  "@endpointingDelayDesc": { "description": "Endpointing delay description" },

  "wakeWord": "Wake Word",
  "@wakeWord": { "description": "Wake word section" },

  "serverSideWakeWord": "Server-Side Wake Word",
  "@serverSideWakeWord": { "description": "Wake word toggle label" },

  "activateWithWakePhrase": "Activate with wake phrase",
  "@activateWithWakePhrase": { "description": "Wake word description" },

  "wakeWordModel": "Wake Word Model",
  "@wakeWordModel": { "description": "Wake word model dropdown" },

  "threshold": "Threshold",
  "@threshold": { "description": "Threshold field" },

  "timeout": "Timeout (s)",
  "@timeout": { "description": "Timeout field" },

  "language": "Language",
  "@language": { "description": "Language selector label" },

  "languageEnglish": "English",
  "@languageEnglish": { "description": "English option" },

  "languageFrench": "Francais",
  "@languageFrench": { "description": "French option" },

  "changesNote": "Note: Model, context size, and wake word changes take effect on next session.",
  "@changesNote": { "description": "Settings note" },

  "failedToLoad": "Failed to load settings: {error}",
  "@failedToLoad": { "description": "Load error", "placeholders": { "error": { "type": "String" } } },

  "failedToSave": "Failed to save: {error}",
  "@failedToSave": { "description": "Save error", "placeholders": { "error": { "type": "String" } } },

  "failedToSaveAgent": "Failed to save agent settings: {code}",
  "@failedToSaveAgent": { "description": "Agent save error", "placeholders": { "code": { "type": "int" } } },

  "downloadingVoice": "Downloading voice model...",
  "@downloadingVoice": { "description": "Voice download status" }
}
```

**app_fr.arb** (French translations):
```json
{
  "@@locale": "fr",

  "welcomeSubtitle": "Discutez en direct avec votre assistant vocal IA",
  "talkToAgent": "Parler a CAAL",
  "connecting": "Connexion",
  "agentListening": "CAAL ecoute",
  "agentIsListening": "L'agent ecoute",
  "startConversation": "Commencez une conversation pour voir les messages ici.",
  "sayWakeWord": "Dites \"Hey Jarvis\"",
  "waitingForWakeWord": "En attente du mot d'activation...",
  "screenshareView": "Vue du partage d'ecran",
  "settings": "Parametres",
  "settingsTitle": "Parametres",
  "caalSetup": "Configuration CAAL",
  "save": "Enregistrer",
  "saving": "Enregistrement...",
  "test": "Tester",
  "connect": "CONNECTER",
  "connection": "Connexion",
  "serverUrl": "URL du serveur",
  "serverUrlHint": "http://192.168.1.100:3000",
  "serverUrlRequired": "L'URL du serveur est requise",
  "serverUrlInvalid": "Entrez une URL valide",
  "yourServerAddress": "L'adresse de votre serveur CAAL",
  "connectedToServer": "Connecte au serveur CAAL",
  "enterServerFirst": "Entrez d'abord une URL de serveur valide",
  "serverReturned": "Le serveur a renvoye {code}",
  "couldNotConnect": "Impossible de se connecter au serveur",
  "couldNotReach": "Impossible d'atteindre le serveur",
  "completeWizardFirst": "Completez d'abord l'assistant de demarrage dans votre navigateur",
  "enterServerToStart": "Entrez l'adresse de votre serveur pour commencer",
  "completeWizardHint": "Completez l'assistant de demarrage dans votre navigateur, puis connectez-vous ici.",
  "connectToServerFirst": "Connectez-vous au serveur pour configurer les parametres de l'agent",
  "agent": "Agent",
  "agentName": "Nom de l'agent",
  "wakeGreetings": "Messages d'accueil",
  "onePerLine": "Un message par ligne",
  "providers": "Fournisseurs",
  "llmProvider": "Fournisseur LLM",
  "ollamaLocalPrivate": "Local, prive",
  "groqFastCloud": "Cloud rapide",
  "ollamaHost": "Hote Ollama",
  "apiKey": "Cle API",
  "model": "Modele",
  "modelsAvailable": "{count} modeles disponibles",
  "apiKeyConfigured": "Cle API configuree (entrez une nouvelle cle pour changer)",
  "connectionFailed": "Echec de la connexion",
  "failedToConnect": "Echec de la connexion",
  "failedToValidate": "Echec de la validation",
  "invalidApiKey": "Cle API invalide",
  "ttsProvider": "Fournisseur TTS",
  "kokoroGpuNeural": "TTS neuronal GPU",
  "piperCpuLightweight": "Leger sur CPU",
  "voice": "Voix",
  "integrations": "Integrations",
  "homeAssistant": "Home Assistant",
  "hostUrl": "URL de l'hote",
  "accessToken": "Jeton d'acces",
  "connectedEntities": "Connecte - {count} entites",
  "connected": "Connecte",
  "n8nMcpNote": "/mcp-server/http sera ajoute automatiquement",
  "llmSettings": "Parametres LLM",
  "temperature": "Temperature",
  "contextSize": "Taille du contexte",
  "maxTurns": "Tours maximum",
  "toolCache": "Cache d'outils",
  "allowInterruptions": "Autoriser les interruptions",
  "interruptAgent": "Interrompre l'agent pendant qu'il parle",
  "endpointingDelay": "Delai de fin (s)",
  "endpointingDelayDesc": "Temps d'attente apres que vous arretez de parler",
  "wakeWord": "Mot d'activation",
  "serverSideWakeWord": "Mot d'activation serveur",
  "activateWithWakePhrase": "Activer avec la phrase d'activation",
  "wakeWordModel": "Modele de mot d'activation",
  "threshold": "Seuil",
  "timeout": "Delai (s)",
  "language": "Langue",
  "languageEnglish": "English",
  "languageFrench": "Francais",
  "changesNote": "Note : Les changements de modele, taille du contexte et mot d'activation prennent effet a la prochaine session.",
  "failedToLoad": "Echec du chargement des parametres : {error}",
  "failedToSave": "Echec de l'enregistrement : {error}",
  "failedToSaveAgent": "Echec de l'enregistrement des parametres de l'agent : {code}",
  "downloadingVoice": "Telechargement du modele vocal..."
}
```

Run `flutter gen-l10n` or `flutter pub get` to generate the AppLocalizations class.
  </action>
  <verify>
    - Both ARB files exist with matching keys (except @metadata)
    - `flutter gen-l10n` generates `.dart_tool/flutter_gen/gen_l10n/app_localizations.dart`
    - No build errors when running `flutter build apk --debug`
  </verify>
  <done>EN/FR ARB files created with all screen strings, code generation produces AppLocalizations class</done>
</task>

<task type="auto">
  <name>Task 3: Create LocaleProvider and wire MaterialApp</name>
  <files>
    mobile/lib/providers/locale_provider.dart
    mobile/lib/app.dart
    mobile/lib/main.dart
  </files>
  <action>
1. Create `mobile/lib/providers/locale_provider.dart`:
```dart
import 'dart:convert';
import 'package:flutter/material.dart';
import 'package:http/http.dart' as http;

/// Manages app locale with backend sync.
/// Locale is loaded from backend settings on app start and saved on change.
class LocaleProvider extends ChangeNotifier {
  Locale _locale = const Locale('en');
  Locale get locale => _locale;

  static const supportedLocales = [Locale('en'), Locale('fr')];

  /// Load locale from backend settings.
  Future<void> loadFromSettings(String serverUrl) async {
    if (serverUrl.isEmpty) return;

    try {
      final uri = Uri.tryParse(serverUrl);
      if (uri == null) return;
      final webhookUrl = 'http://${uri.host}:8889';

      final response = await http.get(Uri.parse('$webhookUrl/settings')).timeout(
        const Duration(seconds: 5),
      );

      if (response.statusCode == 200) {
        final data = jsonDecode(response.body);
        final lang = data['settings']?['language'] ?? 'en';
        final newLocale = Locale(lang);
        if (supportedLocales.contains(newLocale) && newLocale != _locale) {
          _locale = newLocale;
          notifyListeners();
        }
      }
    } catch (e) {
      // Keep default locale on error
    }
  }

  /// Change locale and save to backend.
  Future<void> setLocale(Locale newLocale, String serverUrl) async {
    if (newLocale == _locale) return;
    if (!supportedLocales.contains(newLocale)) return;

    // Update local state first for immediate UI feedback
    _locale = newLocale;
    notifyListeners();

    // Save to backend
    if (serverUrl.isNotEmpty) {
      try {
        final uri = Uri.tryParse(serverUrl);
        if (uri == null) return;
        final webhookUrl = 'http://${uri.host}:8889';

        await http.post(
          Uri.parse('$webhookUrl/settings'),
          headers: {'Content-Type': 'application/json'},
          body: jsonEncode({
            'settings': {'language': newLocale.languageCode}
          }),
        );
      } catch (e) {
        // Locale already updated locally, backend sync failed silently
      }
    }
  }
}
```

2. Update `mobile/lib/main.dart` to create LocaleProvider at app startup:
   - Import LocaleProvider
   - Create instance before runApp
   - Pass to CaalApp

3. Update `mobile/lib/app.dart`:
   - Add imports at top:
     ```dart
     import 'package:flutter_localizations/flutter_localizations.dart';
     import 'package:flutter_gen/gen_l10n/app_localizations.dart';
     import 'providers/locale_provider.dart';
     ```
   - Add LocaleProvider as parameter to CaalApp constructor
   - Wrap the outer-most provider chain with ChangeNotifierProvider.value for LocaleProvider
   - Add Consumer<LocaleProvider> around each MaterialApp
   - Configure MaterialApp with:
     ```dart
     locale: localeProvider.locale,
     localizationsDelegates: const [
       AppLocalizations.delegate,
       GlobalMaterialLocalizations.delegate,
       GlobalWidgetsLocalizations.delegate,
       GlobalCupertinoLocalizations.delegate,
     ],
     supportedLocales: LocaleProvider.supportedLocales,
     ```
   - Load locale from backend after config service is available (call localeProvider.loadFromSettings in initState if configured)
  </action>
  <verify>
    - App builds without errors: `flutter build apk --debug`
    - App launches and displays in English by default
    - No null errors accessing AppLocalizations.of(context)
  </verify>
  <done>LocaleProvider created and MaterialApp wired with localization delegates, locale loads from backend on app start</done>
</task>

</tasks>

<verification>
After completing all tasks:
1. Run `flutter pub get` in mobile directory - no errors
2. Run `flutter gen-l10n` - generates app_localizations.dart
3. Run `flutter build apk --debug` - builds successfully
4. Launch app - displays in English by default
5. Verify AppLocalizations can be accessed: add temporary `print(AppLocalizations.of(context)!.welcomeSubtitle)` in any widget
</verification>

<success_criteria>
- flutter_localizations SDK installed and configured
- l10n.yaml created with proper settings
- EN/FR ARB files exist with 80+ translation keys each
- LocaleProvider manages locale state with backend sync
- MaterialApp wired with localization delegates
- App builds and runs without errors
- Code generation produces AppLocalizations class
</success_criteria>

<output>
After completion, create `.planning/phases/03-mobile-i18n/03-01-SUMMARY.md`
</output>
