---
phase: 03-mobile-i18n
plan: 02
type: execute
wave: 2
depends_on: [03-01]
files_modified:
  - mobile/lib/screens/welcome_screen.dart
  - mobile/lib/screens/setup_screen.dart
  - mobile/lib/screens/settings_screen.dart
  - mobile/lib/screens/agent_screen.dart
  - mobile/lib/widgets/control_bar.dart
  - mobile/lib/widgets/message_bar.dart
autonomous: true

must_haves:
  truths:
    - "User sees all app text in their configured language"
    - "User can change language via selector in settings"
    - "Language change saves to backend and updates UI immediately"
    - "All screens display localized content (welcome, setup, settings, agent)"
  artifacts:
    - path: "mobile/lib/screens/settings_screen.dart"
      provides: "Localized settings with language selector"
      contains: "AppLocalizations.of"
    - path: "mobile/lib/screens/welcome_screen.dart"
      provides: "Localized welcome screen"
      contains: "AppLocalizations.of"
    - path: "mobile/lib/screens/setup_screen.dart"
      provides: "Localized setup screen"
      contains: "AppLocalizations.of"
    - path: "mobile/lib/screens/agent_screen.dart"
      provides: "Localized agent screen"
      contains: "AppLocalizations.of"
  key_links:
    - from: "mobile/lib/screens/settings_screen.dart"
      to: "LocaleProvider"
      via: "context.read<LocaleProvider>()"
      pattern: "setLocale"
    - from: "mobile/lib/screens/settings_screen.dart"
      to: "AppLocalizations"
      via: "l10n variable"
      pattern: "final l10n = AppLocalizations\\.of"
---

<objective>
Localize all mobile app screens and add language selector to settings, completing the mobile i18n implementation.

Purpose: Allow users to interact with the mobile app entirely in their configured language (EN or FR), with the ability to change language from settings.

Output: All screens using localized strings via AppLocalizations, language selector in settings that syncs with backend.
</objective>

<execution_context>
@/Users/mmaudet/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mmaudet/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-mobile-i18n/03-RESEARCH.md
@.planning/phases/03-mobile-i18n/03-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Localize welcome and setup screens</name>
  <files>
    mobile/lib/screens/welcome_screen.dart
    mobile/lib/screens/setup_screen.dart
  </files>
  <action>
**welcome_screen.dart:**

1. Add import at top:
   ```dart
   import 'package:flutter_gen/gen_l10n/app_localizations.dart';
   ```

2. In the build method, get localizations:
   ```dart
   final l10n = AppLocalizations.of(context)!;
   ```

3. Replace hardcoded strings:
   - `'Chat live with your voice AI agent'` -> `l10n.welcomeSubtitle`
   - `'CAAL is listening'` -> `l10n.agentListening`
   - `'Connecting'` -> `l10n.connecting`
   - `'Talk to CAAL'` -> `l10n.talkToAgent`
   - `'Settings'` (tooltip) -> `l10n.settings`

**setup_screen.dart:**

1. Add import at top:
   ```dart
   import 'package:flutter_gen/gen_l10n/app_localizations.dart';
   ```

2. In the build method, get localizations:
   ```dart
   final l10n = AppLocalizations.of(context)!;
   ```

3. Replace hardcoded strings:
   - `'CAAL Setup'` -> `l10n.caalSetup`
   - `'Connection'` -> `l10n.connection`
   - `'Enter your server address to get started'` -> `l10n.enterServerToStart`
   - `'Server URL'` -> `l10n.serverUrl`
   - `'http://192.168.1.100:3000'` (hint) -> `l10n.serverUrlHint`
   - `'Server URL is required'` -> `l10n.serverUrlRequired`
   - `'Enter a valid URL (e.g., http://192.168.1.100:3000)'` -> `l10n.serverUrlInvalid`
   - `'Your CAAL server address'` -> `l10n.yourServerAddress`
   - `'Invalid server URL'` -> `l10n.serverUrlInvalid`
   - `'Complete the first-start wizard in your browser first'` -> `l10n.completeWizardFirst`
   - `'Could not reach server'` -> `l10n.couldNotReach`
   - `'Could not connect to server'` -> `l10n.couldNotConnect`
   - `'CONNECT'` -> `l10n.connect`
   - `'SAVE'` -> `l10n.save`
   - `'Complete the first-start wizard in your browser, then connect here.'` -> `l10n.completeWizardHint`
  </action>
  <verify>
    - Welcome screen displays localized text
    - Setup screen displays localized text
    - No hardcoded English strings remain in these files
    - App builds without errors
  </verify>
  <done>Welcome and setup screens fully localized with AppLocalizations</done>
</task>

<task type="auto">
  <name>Task 2: Localize settings screen and add language selector</name>
  <files>
    mobile/lib/screens/settings_screen.dart
  </files>
  <action>
1. Add imports at top:
   ```dart
   import 'package:flutter_gen/gen_l10n/app_localizations.dart';
   import 'package:provider/provider.dart';
   import '../providers/locale_provider.dart';
   ```

2. In the build method, get localizations:
   ```dart
   final l10n = AppLocalizations.of(context)!;
   ```

3. Replace ALL hardcoded strings with l10n calls. Key replacements:
   - Section headers: `'Connection'` -> `l10n.connection`, `'Agent'` -> `l10n.agent`, `'Providers'` -> `l10n.providers`, etc.
   - Labels: `'Server URL'` -> `l10n.serverUrl`, `'Agent Name'` -> `l10n.agentName`, etc.
   - Buttons: `'Save'` -> `l10n.save`, `'Test'` -> `l10n.test`
   - Status messages: `'Connected to CAAL server'` -> `l10n.connectedToServer`
   - Errors: `'Server URL is required'` -> `l10n.serverUrlRequired`
   - Provider labels: `'Ollama'`, `'Groq'`, `'Kokoro'`, `'Piper'` stay as-is (technical terms)
   - Provider subtitles: `'Local, private'` -> `l10n.ollamaLocalPrivate`, `'Fast cloud'` -> `l10n.groqFastCloud`
   - For strings with placeholders like `'${_ollamaModels.length} models available'` -> `l10n.modelsAvailable(_ollamaModels.length)`

4. Add language selector AFTER the Connection section (before Agent section):
   ```dart
   // Language Section (after Connection card, before Agent)
   const SizedBox(height: 24),
   _buildSectionHeader(l10n.language, Icons.language),
   _buildCard([
     _buildLabel(l10n.language),
     DropdownButtonFormField<String>(
       value: context.watch<LocaleProvider>().locale.languageCode,
       style: const TextStyle(color: Colors.white),
       dropdownColor: const Color(0xFF2A2A2A),
       decoration: _inputDecoration(),
       items: [
         DropdownMenuItem(value: 'en', child: Text(l10n.languageEnglish)),
         DropdownMenuItem(value: 'fr', child: Text(l10n.languageFrench)),
       ],
       onChanged: (value) async {
         if (value != null) {
           final localeProvider = context.read<LocaleProvider>();
           await localeProvider.setLocale(
             Locale(value),
             widget.configService.serverUrl,
           );
         }
       },
     ),
   ]),
   ```

5. Ensure strings with dynamic values use proper placeholders:
   - `'Server returned ${response.statusCode}'` -> `l10n.serverReturned(response.statusCode)`
   - `'${_ollamaModels.length} models available'` -> `l10n.modelsAvailable(_ollamaModels.length)`
   - `'Connected - ${result['device_count']} entities'` -> `l10n.connectedEntities(result['device_count'])`
   - `'Failed to load settings: $e'` -> `l10n.failedToLoad(e.toString())`
   - `'Failed to save: $e'` -> `l10n.failedToSave(e.toString())`
   - `'Failed to save agent settings: ${res.statusCode}'` -> `l10n.failedToSaveAgent(res.statusCode)`

6. Keep technical terms in English (do NOT localize):
   - Ollama, Groq, Kokoro, Piper
   - n8n, Home Assistant
   - LLM, TTS, API
   - Model names

7. Update AppBar title:
   - `isFirstSetup ? 'CAAL Setup' : 'Settings'` -> `isFirstSetup ? l10n.caalSetup : l10n.settingsTitle`
  </action>
  <verify>
    - Settings screen displays all text in selected language
    - Language selector appears after Connection section
    - Changing language updates UI immediately
    - Language change persists (saved to backend)
    - Technical terms remain in English
    - App builds without errors
  </verify>
  <done>Settings screen fully localized with language selector that syncs to backend</done>
</task>

<task type="auto">
  <name>Task 3: Localize agent screen and remaining widgets</name>
  <files>
    mobile/lib/screens/agent_screen.dart
    mobile/lib/widgets/control_bar.dart
    mobile/lib/widgets/message_bar.dart
  </files>
  <action>
**agent_screen.dart:**

1. Add import at top:
   ```dart
   import 'package:flutter_gen/gen_l10n/app_localizations.dart';
   ```

2. In _AgentListeningPlaceholder, get localizations in build:
   ```dart
   final l10n = AppLocalizations.of(context)!;
   ```

3. Replace hardcoded strings:
   - `'Say "Hey Jarvis"'` -> `l10n.sayWakeWord`
   - `'Waiting for wake word...'` -> `l10n.waitingForWakeWord`
   - `'Agent is listening'` -> `l10n.agentIsListening`
   - `'Start a conversation to see messages here.'` -> `l10n.startConversation`
   - `'Screenshare View'` -> `l10n.screenshareView`

**control_bar.dart** (if it has hardcoded strings):
- Check for any tooltips or labels and localize them

**message_bar.dart** (if it has hardcoded strings):
- Check for placeholder text and localize if present
  </action>
  <verify>
    - Agent screen displays localized text
    - Wake word prompts display in selected language
    - Empty state messages display in selected language
    - App builds without errors
    - Full app flow works: welcome -> connect -> agent -> settings (all localized)
  </verify>
  <done>Agent screen and remaining widgets fully localized</done>
</task>

</tasks>

<verification>
After completing all tasks, verify complete localization:

1. Build app: `cd mobile && flutter build apk --debug`
2. Launch app on device/emulator
3. Verify English (default):
   - Welcome screen shows "Chat live with your voice AI agent"
   - Setup/Settings shows localized labels
   - Agent screen shows "Agent is listening"
4. Change language to French in settings
5. Verify French immediately:
   - All screens update to French
   - "Discutez en direct avec votre assistant vocal IA"
   - Settings labels in French
6. Restart app - verify French persists (loaded from backend)
7. Change back to English - verify immediate update
</verification>

<success_criteria>
- All four screens (welcome, setup, settings, agent) display localized content
- Language selector in settings saves to backend and updates UI immediately
- Language persists across app restarts (loaded from backend)
- No hardcoded English strings remain in localized screens
- Technical terms (Ollama, Groq, etc.) stay in English
- App builds and runs without errors
- MOBILE-01 through MOBILE-05 requirements satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/03-mobile-i18n/03-02-SUMMARY.md`
</output>
