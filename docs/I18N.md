# Internationalization (i18n)

CAAL supports multiple languages across all components: voice pipeline (STT, LLM, TTS), web frontend, and mobile app. Language is configured globally — changing it in any client propagates to the voice agent automatically.

## Supported Languages

| Code | Language | Frontend | Mobile | Voice (STT/TTS) | Prompts |
|------|----------|----------|--------|------------------|---------|
| `en` | English  | Yes      | Yes    | Yes              | Yes     |
| `fr` | French   | Yes      | Yes    | Yes              | Yes     |

## Changing the Language

### From the Web UI

1. Open **Settings** (gear icon)
2. Under the **General** tab, find the **Language** dropdown
3. Select the desired language
4. The page reloads automatically with the new locale

### From the Mobile App

1. Open **Settings**
2. Tap the **Language** selector
3. Choose the desired language
4. The app refreshes immediately

### Via API

```bash
curl -X POST http://localhost:8889/settings \
  -H "Content-Type: application/json" \
  -d '{"settings": {"language": "fr"}}'
```

### Via settings.json

Edit `settings.json` at the project root and set the `language` field:

```json
{
  "language": "fr"
}
```

The agent reads this on each new session — no restart required.

## How It Works

### Architecture

```
settings.json (language: "fr")
    |
    +-- Frontend: CAAL_LOCALE cookie --> next-intl --> French UI
    |
    +-- Mobile: LocaleProvider --> Flutter intl --> French UI
    |
    +-- Voice Agent:
            +-- STT: language="fr" parameter to Whisper
            +-- LLM: French system prompt (prompt/fr/default.md)
            +-- TTS: French voice (Piper siwis-medium)
            +-- Wake greetings: French defaults
            +-- Date/time: French formatting in context
```

### Settings Propagation

1. User changes language in any client (web, mobile, or API)
2. Client sends `POST /settings` with `{"settings": {"language": "fr"}}`
3. Backend saves to `settings.json`
4. Frontend sets a `CAAL_LOCALE` cookie and reloads
5. Mobile updates its `LocaleProvider` state
6. The next voice session reads the updated setting at startup

### Voice Pipeline

When a voice session starts, the language setting affects:

- **STT**: The `language` parameter is passed to Whisper (Groq or Speaches), improving transcription accuracy for the target language.
- **System Prompt**: Loaded from `prompt/{language}/default.md`. The French prompt includes "Reponds toujours en francais" to ensure the LLM responds in French.
- **TTS Voice**: Automatically selects a language-appropriate Piper voice. Kokoro TTS auto-switches to Piper for non-English languages.
- **Wake Greetings**: Per-language greeting sets are used unless the user has customized their own.
- **Date/Time Context**: Injected into the system prompt using localized formatting (e.g., "mercredi 21 janvier 2026", "15 heures 30").

### TTS Voice Mapping

| Language | Piper Voice | Description |
|----------|------------|-------------|
| `en`     | `piper-en_US-ryan-high` | Male, US English, high quality |
| `fr`     | `piper-fr_FR-siwis-medium` | Female, French, medium quality |

If Kokoro TTS is configured but the language is not English, the agent automatically switches to Piper with the appropriate voice.

## Adding a New Language

To add support for a new language (e.g., German `de`):

### 1. Voice Pipeline

**a) System prompt** — Create `prompt/de/default.md` with a German version of the system prompt. Include an instruction like "Antworte immer auf Deutsch."

**b) TTS voice** — Add a Piper voice mapping in `voice_agent.py`:

```python
PIPER_VOICE_MAP = {
    "en": "speaches-ai/piper-en_US-ryan-high",
    "fr": "speaches-ai/piper-fr_FR-siwis-medium",
    "de": "speaches-ai/piper-de_DE-thorsten-high",  # add this
}
```

**c) Wake greetings** — Add a greeting set in `voice_agent.py`:

```python
DEFAULT_WAKE_GREETINGS = {
    "en": [...],
    "fr": [...],
    "de": [  # add this
        "Hallo!",
        "Ja?",
        "Was kann ich fur dich tun?",
    ],
}
```

**d) Date/time formatting** — Add a formatter in `src/caal/utils/formatting.py` following the pattern of `_format_date_french()` and `_format_time_french()`.

### 2. Frontend

**a) Message file** — Create `frontend/messages/de.json` using `en.json` as a template. Translate all values.

**b) Locale config** — Add `'de'` to the locales array in `frontend/src/i18n/config.ts`:

```typescript
export const locales = ['en', 'fr', 'de'] as const;
```

**c) Language selector** — Add the language to the `LANGUAGES` array in `frontend/components/settings/settings-panel.tsx`:

```typescript
const LANGUAGES = [
  { code: 'en', name: 'English' },
  { code: 'fr', name: 'Francais' },
  { code: 'de', name: 'Deutsch' },  // add this
] as const;
```

### 3. Mobile

**a) ARB file** — Create `mobile/lib/l10n/app_de.arb` using `app_en.arb` as a template. Translate all values.

**b) Locale provider** — Add the locale in `mobile/lib/providers/locale_provider.dart`:

```dart
static const supportedLocales = [Locale('en'), Locale('fr'), Locale('de')];
```

**c) Language option** — Add the language to the mobile settings screen.

### 4. Piper Model

Ensure the Piper TTS model is available. Either pre-install it or let Speaches download it on first use:

```bash
curl -X POST http://localhost:8000/v1/models/speaches-ai/piper-de_DE-thorsten-high
```

## File Reference

| Component | File | Purpose |
|-----------|------|---------|
| Settings  | `src/caal/settings.py` | Language storage, prompt loading |
| Voice     | `voice_agent.py` | Voice map, wake greetings, pipeline config |
| Formatting | `src/caal/utils/formatting.py` | Localized date/time |
| Prompt EN | `prompt/en/default.md` | English system prompt |
| Prompt FR | `prompt/fr/default.md` | French system prompt |
| Frontend config | `frontend/src/i18n/config.ts` | Locale list |
| Frontend request | `frontend/src/i18n/request.ts` | Cookie-based locale detection |
| Frontend EN | `frontend/messages/en.json` | English UI translations |
| Frontend FR | `frontend/messages/fr.json` | French UI translations |
| Mobile provider | `mobile/lib/providers/locale_provider.dart` | Locale state management |
| Mobile EN | `mobile/lib/l10n/app_en.arb` | English mobile translations |
| Mobile FR | `mobile/lib/l10n/app_fr.arb` | French mobile translations |
| Webhooks | `src/caal/webhooks.py` | `/settings` API endpoint |
